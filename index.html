<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar sesión</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="layout">
    <!-- Panel lateral sin botones -->
    <aside class="sidebar">
      <div class="sidebar-content">
        <h2>Sistema de Gestión</h2>
        <p>Acceda a su cuenta para gestionar clientes, empresas y ventas</p>
      </div>
    </aside>

    <!-- Contenido principal -->
    <main class="login-section">
      <div class="login-box">
        <h1>Iniciar sesión</h1>

        <form id="loginForm">
          <label for="usuario">Usuario</label>
          <input type="text" id="usuario" name="usuario" placeholder="HT1Z24JU" required>

          <label for="password">Contraseña</label>
          <input type="password" id="password" name="password" placeholder="************" required>

          <button type="submit" class="btn-login">Iniciar sesión</button>
        </form>
        <div id="message" class="message"></div>
      </div>
    </main>
  </div>

  <script>
    // Prevenir que se pueda volver atrás al historial
    if (window.history && window.history.pushState) {
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function(event) {
            window.history.go(1);
        };
    }

    // Limpiar cualquier sesión residual del localStorage/sessionStorage
    localStorage.removeItem('user_session');
    sessionStorage.removeItem('user_session');

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const usuario = document.getElementById('usuario').value;
      const password = document.getElementById('password').value;
      const messageDiv = document.getElementById('message');
      
      // Mostrar mensaje de carga
      messageDiv.textContent = 'Verificando credenciales...';
      messageDiv.className = 'message loading';
      
      // Crear objeto FormData
      const formData = new FormData();
      formData.append('usuario', usuario);
      formData.append('password', password);
      
      // Enviar datos mediante AJAX
      fetch('login.php', {
        method: 'POST',
        body: formData,
        headers: {
          'Cache-Control': 'no-cache'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          messageDiv.textContent = data.message;
          messageDiv.className = 'message success';
          
          // Usar replace para evitar que quede en el historial
          setTimeout(() => {
            window.location.replace(data.redirect);
          }, 1000);
        } else {
          messageDiv.textContent = data.message;
          messageDiv.className = 'message error';
        }
      })
      .catch(error => {
        messageDiv.textContent = 'Error de conexión: ' + error;
        messageDiv.className = 'message error';
      });
    });

    // Prevenir el uso de cache
    window.onpageshow = function(event) {
      if (event.persisted) {
        window.location.reload();
      }
    };
  </script>
</body>
</html>